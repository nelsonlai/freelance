-- Problem: Average Salary: Departments VS Company
-- Difficulty: Hard
-- Tags: Database

SELECT 
    pay_month,
    department_id,
    CASE 
        WHEN dept_avg > company_avg THEN 'higher'
        WHEN dept_avg < company_avg THEN 'lower'
        ELSE 'same'
    END AS comparison
FROM (
    SELECT 
        DATE_FORMAT(s.pay_date, '%Y-%m') AS pay_month,
        e.department_id,
        AVG(s.amount) AS dept_avg,
        (SELECT AVG(amount) FROM salary WHERE DATE_FORMAT(pay_date, '%Y-%m') = DATE_FORMAT(s.pay_date, '%Y-%m')) AS company_avg
    FROM salary s
    JOIN employee e ON s.employee_id = e.employee_id
    GROUP BY pay_month, e.department_id
) t
ORDER BY pay_month DESC, department_id;
