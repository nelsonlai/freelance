---
title: "Data Manipulation with dplyr"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(dplyr)
```

# Data Manipulation with dplyr

The `dplyr` package provides a grammar of data manipulation, making it easy to work with data frames.

## Why dplyr?

dplyr makes data manipulation:
- **Fast** - written in C++
- **Readable** - intuitive syntax
- **Consistent** - same verbs for different operations
- **Powerful** - handles large datasets efficiently

## Load the Package

```{r load-package}
library(dplyr)
```

## The Five Key Verbs

dplyr provides five key functions (verbs) for data manipulation:
1. `filter()` - keep rows that match conditions
2. `select()` - pick variables (columns)
3. `mutate()` - create new variables
4. `arrange()` - sort rows
5. `summarize()` - collapse to summary statistics

## Filter Rows with `filter()`

Keep rows that meet your criteria:

```{r filter-example}
# Load built-in dataset
data("mtcars")

# Filter cars with mpg greater than 20
mtcars %>%
  filter(mpg > 20)

# Multiple conditions
mtcars %>%
  filter(mpg > 20, cyl == 4)

# Using 'or' operator
mtcars %>%
  filter(mpg > 30 | hp < 100)
```

## Select Columns with `select()`

Pick variables to work with:

```{r select-example}
# Select specific columns
mtcars %>%
  select(mpg, hp, wt)

# Select a range of columns
mtcars %>%
  select(mpg:wt)

# Select columns to exclude
mtcars %>%
  select(-mpg, -hp)

# Select columns by name pattern
mtcars %>%
  select(starts_with("m"))
```

## Create Variables with `mutate()`

Add new columns to your data:

```{r mutate-example}
mtcars %>%
  mutate(
    hp_per_cyl = hp / cyl,
    weight_kg = wt * 453.592
  ) %>%
  head()

# Use ifelse() in mutate
mtcars %>%
  mutate(
    fuel_category = ifelse(mpg > 20, "Efficient", "Less Efficient")
  ) %>%
  select(mpg, fuel_category)
```

## Arrange Rows with `arrange()`

Sort your data:

```{r arrange-example}
# Sort by mpg (ascending)
mtcars %>%
  arrange(mpg) %>%
  head()

# Sort by mpg (descending)
mtcars %>%
  arrange(desc(mpg)) %>%
  head()

# Sort by multiple columns
mtcars %>%
  arrange(desc(mpg), desc(hp)) %>%
  head()
```

## Summarize Data with `summarize()`

Collapse multiple rows into summary statistics:

```{r summarize-example}
mtcars %>%
  summarize(
    mean_mpg = mean(mpg),
    median_mpg = median(mpg),
    max_hp = max(hp),
    count = n()
  )
```

## Group Operations with `group_by()`

Perform operations by groups:

```{r group-by-example}
mtcars %>%
  group_by(cyl) %>%
  summarize(
    mean_mpg = mean(mpg),
    count = n()
  )
```

## The Pipe Operator `%>%`

The pipe `%>%` passes the result to the next function:

```{r pipe-example}
# Without pipe (nested functions)
arrange(filter(mtcars, mpg > 20), desc(hp))

# With pipe (readable!)
mtcars %>%
  filter(mpg > 20) %>%
  arrange(desc(hp))

# Complex operation
mtcars %>%
  filter(mpg > 20) %>%
  select(mpg, hp, wt) %>%
  mutate(hp_per_weight = hp / wt) %>%
  arrange(desc(hp_per_weight)) %>%
  head()
```

## Combining Multiple Operations

```{r complex-example}
result <- mtcars %>%
  filter(cyl == 4 | cyl == 6) %>%
  select(mpg, hp, cyl) %>%
  mutate(
    efficient = mpg > 22,
    powerful = hp > 100
  ) %>%
  arrange(desc(mpg))

head(result)
```

## Additional Useful Functions

```{r additional-functions}
# distinct() - get unique values
mtcars %>%
  distinct(cyl)

# rename() - rename columns
mtcars %>%
  rename(horsepower = hp) %>%
  head()

# slice() - select rows by position
mtcars %>%
  slice(1:5)

mtcars %>%
  slice_max(mpg, n = 5)

mtcars %>%
  slice_min(mpg, n = 5)
```

## Practice Exercise

```{r exercise}
# Exercise: From mtcars data
# 1. Filter cars with 4 or 6 cylinders
# 2. Select mpg, cyl, hp, wt
# 3. Create a variable: hp_per_weight
# 4. Find cars with hp_per_weight > 50
# 5. Arrange by hp_per_weight descending

# Your solution here:
```

## Summary

In this lesson, you learned:
- How to filter rows with `filter()`
- How to select columns with `select()`
- How to create new variables with `mutate()`
- How to sort with `arrange()`
- How to summarize with `summarize()`
- How to group operations with `group_by()`
- How to chain operations with `%>%`

## Next Steps

Practice these functions on your own data and move to the next lesson on data reshaping!

